pipeline {
    agent any
    environment {
        DOCKER_IMAGE = 'tic-tac-toe'
        REGISTRY_CREDENTIALS = 'dockerhub-credentials'
        GIT_CREDENTIALS = 'cherpalli-shiva'
        GIT_REPO = 'https://github.com/cherpalli-shiva/tic-tac.git'
        K8S_MANIFEST_PATH = 'k8s/deployment.yaml'
    }

    stages {
        stage('Checkout') {
            steps {
                git credentialsId: env.GIT_CREDENTIALS, url: env.GIT_REPO
            }
        }
        stage('Build Docker Image') {
            steps {
                script {
                    dockerImage = docker.build("${DOCKER_IMAGE}:${env.BUILD_NUMBER}")
                }
            }
        }
        stage('Run Tests') {
            steps {
                script {
                    // Assuming tests are run using npm
                    sh 'npm install'
                    sh 'npm test'
                }
            }
        }
        stage('SonarQube Analysis') {
            steps {
                script {
                    // Assuming SonarQube is set up and configured
                    withSonarQubeEnv('Sonar-server') {
                        sh 'npm install'
                        sh 'sonar-scanner -Dsonar.projectKey=tic-tac-toe -Dsonar.sources=src'
                    }
                }
            }
        }
        stage('Push Docker Image') {
            steps {
                script {
                    docker.withRegistry('',"${REGISTRY_CREDENTIALS}") {
                        dockerImage.push()
                        dockerImage.push('latest')
                    }
                }
            }
        }
        stage('Update k8s manifest') {
            steps {
                script {
                    // Update the image in the k8s manifest
                    sh """
                    sed -i 's|image: .*|image: ${DOCKER_IMAGE}:${BUILD_NUMBER}|' ${K8S_MANIFEST_PATH}
                    """
                }
            }
        }
        stage('Commit and Push k8s Manifest') {
            steps {
                script {
                    sh """
                    git config user.email "cherpallishiva123@gmail.com"
                    git config user.name "Jenkins CI"
                    git add ${K8S_MANIFEST_PATH}
                    git commit -m "Update k8s manifest with new image ${DOCKER_IMAGE}:${BUILD_NUMBER}"
                    git push origin main
                    """
                }
            }
        }
    }
}